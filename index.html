<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Halloween Spooks NFT - Free Mint</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#0a0514;color:#e0e0e0;min-height:100vh;position:relative;overflow-x:hidden}
    .spooky-bg{position:fixed;inset:0;z-index:-1;background:
      radial-gradient(circle at 20% 50%,rgba(139,0,255,.15) 0%,transparent 50%),
      radial-gradient(circle at 80% 20%,rgba(255,69,0,.1) 0%,transparent 50%),
      radial-gradient(circle at 50% 80%,rgba(0,0,0,.8) 0%,transparent 50%)}
    .floating-ghost{position:fixed;font-size:60px;opacity:.1;animation:float 20s infinite ease-in-out;z-index:-1}
    @keyframes float{0%,100%{transform:translateY(0)translateX(0)}25%{transform:translateY(-30px)translateX(20px)}50%{transform:translateY(-60px)translateX(-20px)}75%{transform:translateY(-30px)translateX(20px)}}
    .container{max-width:600px;margin:0 auto;padding:40px 20px}
    header{text-align:center;margin-bottom:40px;padding-top:10px}
    .logo{font-size:60px;margin-bottom:20px;animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
    h1{font-size:48px;font-weight:900;background:linear-gradient(135deg,#ff6b00 0%,#8b00ff 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:15px;text-shadow:0 0 30px rgba(255,107,0,.3)}
    .subtitle{font-size:18px;color:#b0b0b0;margin-bottom:10px}
    .network-badge{display:inline-block;padding:8px 20px;background:rgba(139,0,255,.2);border:1px solid rgba(139,0,255,.4);border-radius:20px;font-size:13px;color:#8b00ff;font-weight:600}
    .mint-card{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.1);border-radius:24px;padding:40px;backdrop-filter:blur(10px);box-shadow:0 20px 60px rgba(0,0,0,.5)}
    .nft-preview{width:100%;aspect-ratio:1;background:linear-gradient(135deg,rgba(139,0,255,.1) 0%,rgba(255,69,0,.1) 100%);border-radius:20px;display:flex;align-items:center;justify-content:center;font-size:120px;margin-bottom:30px;border:2px solid rgba(139,0,255,.3);position:relative;overflow:hidden}
    .info-section{margin-bottom:30px}
    .info-row{display:flex;justify-content:space-between;padding:15px 0;border-bottom:1px solid rgba(255,255,255,.05)}
    .info-row:last-child{border-bottom:none}
    .info-label{color:#808080;font-size:14px}
    .info-value{color:#fff;font-weight:600;font-size:14px}
    .free-badge{background:linear-gradient(135deg,#ff6b00 0%,#ff4500 100%);padding:4px 12px;border-radius:12px;font-size:12px;font-weight:700;color:white}
    .wallet-address{background:rgba(0,0,0,.3);padding:15px;border-radius:12px;font-family:'Courier New',monospace;font-size:13px;color:#8b00ff;text-align:center;margin-top:15px;border:1px solid rgba(139,0,255,.2)}
    .btn{width:100%;padding:18px;border-radius:16px;font-size:18px;font-weight:700;border:none;cursor:pointer;transition:all .3s ease;display:flex;align-items:center;justify-content:center;gap:12px}
    .btn-primary{background:linear-gradient(135deg,#ff6b00 0%,#8b00ff 100%);color:white;box-shadow:0 10px 40px rgba(255,107,0,.3)}
    .btn-primary:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 15px 50px rgba(255,107,0,.5)}
    .btn-primary:disabled{opacity:.5;cursor:not-allowed}
    .status-message{margin-top:20px;padding:15px;border-radius:12px;font-size:14px;text-align:center;display:none}
    .status-success{background:rgba(0,255,0,.1);border:1px solid rgba(0,255,0,.3);color:#00ff00}
    .status-error{background:rgba(255,0,0,.1);border:1px solid rgba(255,0,0,.3);color:#ff6b6b}
    .status-info{background:rgba(139,0,255,.1);border:1px solid rgba(139,0,255,.3);color:#8b00ff}
    .owned-card{margin-top:22px;background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:16px}
    .owned-grid{display:grid;grid-template-columns:120px 1fr;gap:16px;align-items:center}
    .owned-img{width:100%;aspect-ratio:1;border-radius:12px;object-fit:cover;border:1px solid rgba(255,255,255,.12);cursor:pointer;transition:all .3s ease}
    .owned-img:hover{transform:scale(1.05);border-color:rgba(139,0,255,.5);box-shadow:0 5px 20px rgba(139,0,255,.3)}
    .mono{font-family:'Courier New',monospace;word-break:break-all;color:#c9c9c9}
    
    /* Modal styles */
    .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:1000;backdrop-filter:blur(5px);animation:fadeIn .3s ease}
    .modal-overlay.show{display:flex;align-items:center;justify-content:center;padding:20px}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .modal-content{background:linear-gradient(135deg,rgba(20,10,30,.95) 0%,rgba(10,5,20,.95) 100%);border:2px solid rgba(139,0,255,.4);border-radius:24px;width:90%;max-width:600px;max-height:90vh;overflow-y:auto;box-shadow:0 30px 80px rgba(139,0,255,.5);animation:slideUp .3s ease;position:relative}
    @keyframes slideUp{from{transform:translateY(50px);opacity:0}to{transform:translateY(0);opacity:1}}
    .modal-header{padding:30px 30px 20px;border-bottom:1px solid rgba(255,255,255,.1);display:flex;justify-content:space-between;align-items:center}
    .modal-title{font-size:24px;font-weight:700;background:linear-gradient(135deg,#ff6b00 0%,#8b00ff 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .modal-close{background:none;border:none;color:#fff;font-size:32px;cursor:pointer;width:40px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:all .3s ease}
    .modal-close:hover{background:rgba(255,255,255,.1);transform:rotate(90deg)}
    .modal-body{padding:30px}
    .modal-nft-image{width:100%;aspect-ratio:1;border-radius:16px;object-fit:cover;margin-bottom:30px;border:2px solid rgba(139,0,255,.3)}
    .metadata-section{background:rgba(0,0,0,.3);border-radius:16px;padding:20px;margin-bottom:20px}
    .metadata-title{font-size:18px;font-weight:700;color:#8b00ff;margin-bottom:15px;display:flex;align-items:center;gap:10px}
    .metadata-row{display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid rgba(255,255,255,.05)}
    .metadata-row:last-child{border-bottom:none}
    .metadata-label{color:#888;font-size:14px}
    .metadata-value{color:#fff;font-weight:600;font-size:14px;text-align:right;max-width:60%;word-break:break-word}
    .attributes-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-top:15px}
    .attribute-card{background:rgba(139,0,255,.1);border:1px solid rgba(139,0,255,.3);border-radius:12px;padding:12px;text-align:center}
    .attribute-type{font-size:11px;color:#888;text-transform:uppercase;margin-bottom:5px}
    .attribute-value{font-size:16px;font-weight:700;color:#8b00ff}
  </style>
</head>
<body>
  <div class="spooky-bg"></div>
  <div class="floating-ghost" style="top:10%; left:10%;">ðŸ‘»</div>
  <div class="floating-ghost" style="top:60%; right:15%; animation-delay:-5s;">ðŸŽƒ</div>

  <div class="container">
    <header>
      <div class="logo">ðŸ‘»</div>
      <h1>Halloween Spooks</h1>
      <p class="subtitle">Free NFT Mint with Gasless Transactions</p>
      <div class="network-badge">âš¡ Powered by Meta-Transactions</div>
    </header>

    <div class="mint-card">
      <div class="nft-preview" id="nftPreview">ðŸŽƒ</div>

      <div class="info-section">
        <div class="info-row"><span class="info-label">Price</span><span class="free-badge">FREE</span></div>
        <div class="info-row"><span class="info-label">Limit per wallet</span><span class="info-value">1 NFT</span></div>
        <div class="info-row"><span class="info-label">Gas fees</span><span class="info-value">Sponsored ðŸŽ‰</span></div>
      </div>

      <button class="btn btn-primary" id="connectBtn" onclick="toggleWallet()">
        <span id="connectBtnText">ðŸ¦Š Connect Wallet</span>
      </button>
      <div class="wallet-address" id="walletAddress" style="display:none;"></div>

      <button class="btn btn-primary" id="mintBtn" onclick="mintNFT()" disabled>
        <span id="mintBtnText">Mint my Spook</span>
      </button>

      <div class="status-message" id="statusMessage"></div>

      <div id="ownedSection" class="owned-card" style="display:none;">
        <div class="owned-grid">
          <img id="ownedImg" class="owned-img" alt="Your NFT" onclick="openModal()"/>
          <div>
            <div><strong>You can mint 1 token per address</strong></div>
            <div><strong>Token ID:</strong> <span id="ownedTokenId">-</span></div>
            <div><strong>Token URI:</strong> <span id="ownedTokenUri" class="mono">-</span></div>
          </div>
        </div>
      </div>
    </div>

    <footer>Built with ðŸ’œ using MetaTxKit & ERC-2771</footer>
  </div>

  <!-- Modal -->
  <div class="modal-overlay" id="nftModal" onclick="closeModalOnOverlay(event)">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">ðŸŽƒ Your Halloween Spook</h2>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <img id="modalNftImage" class="modal-nft-image" alt="NFT"/>
        
        <div class="metadata-section">
          <div class="metadata-title">ðŸ“‹ NFT Details</div>
          <div class="metadata-row">
            <span class="metadata-label">Name</span>
            <span class="metadata-value" id="modalName">-</span>
          </div>
          <div class="metadata-row">
            <span class="metadata-label">Description</span>
            <span class="metadata-value" id="modalDescription">-</span>
          </div>
          <div class="metadata-row">
            <span class="metadata-label">Token ID</span>
            <span class="metadata-value" id="modalTokenId">-</span>
          </div>
          <div class="metadata-row">
            <span class="metadata-label">Token URI</span>
            <span class="metadata-value mono" id="modalTokenUri" style="font-size:11px">-</span>
          </div>
        </div>

        <div class="metadata-section" id="attributesSection" style="display:none">
          <div class="metadata-title">âœ¨ Attributes</div>
          <div class="attributes-grid" id="attributesGrid"></div>
        </div>
      </div>
    </div>
  </div>

<script>
const CONFIG = {
  NFT_CONTRACT: '0x0F835E9947f15A799eB173FEFE39f572279fA7Ac',
  HUB_CONTRACT: '0xe8cB75877D6277bCD423f39177BbEB32eDbd899b',
  RELAYER_ENDPOINT: 'http://127.0.0.1:3000/relay',
  CHAIN_ID: 80002,
  HTTP_GATEWAY: 'https://ipfs.io/ipfs/'
};

const NFT_ABI = [
  "function mint(string calldata tokenUri) public",
  "function minted(address) public view returns (bool)",
  "function myToken() public view returns (uint256 id, string memory uri)",
  "function tokenURI(uint256 tokenId) public view returns (string)"
];

let provider, signer, nftContract, userAddress, currentNFTMetadata = {}, isConnected = false;

function showStatus(msg, type){
  const el=document.getElementById('statusMessage');
  el.innerHTML=msg; el.className='status-message status-'+type; el.style.display='block';
}

function ipfsToHttp(uri){
  uri=uri.replace('images/','');
  if(!uri) return ''; 
  if(uri.startsWith('ipfs://')) return CONFIG.HTTP_GATEWAY+uri.replace('ipfs://','');
  return uri;
}

function updateConnectButton(connected){
  const btn = document.getElementById('connectBtn');
  const btnText = document.getElementById('connectBtnText');
  if(connected){
    btnText.textContent = 'ðŸ”Œ Disconnect Wallet';
    btn.style.background = 'linear-gradient(135deg,#ff4500 0%,#dc143c 100%)';
  } else {
    btnText.textContent = 'ðŸ¦Š Connect Wallet';
    btn.style.background = 'linear-gradient(135deg,#ff6b00 0%,#8b00ff 100%)';
  }
}

function resetUI(){
  document.getElementById('walletAddress').style.display='none';
  document.getElementById('mintBtn').disabled=true;
  document.getElementById('ownedSection').style.display='none';
  document.getElementById('statusMessage').style.display='none';
  updateConnectButton(false);
}

async function toggleWallet(){
  if(isConnected){
    disconnectWallet();
  } else {
    await connectWallet();
  }
}

function disconnectWallet(){
  provider = null;
  signer = null;
  nftContract = null;
  userAddress = null;
  currentNFTMetadata = {};
  isConnected = false;
  resetUI();
  showStatus('Wallet disconnected','info');
  setTimeout(() => {
    document.getElementById('statusMessage').style.display='none';
  }, 2000);
}

async function showOwnedNFT(){
  try{
    const res=await nftContract.myToken();
    const id=res.id||res[0];
    const uri=res.uri||res[1];
    if(!id||id==0){ document.getElementById('ownedSection').style.display='none'; return; }
    const metaUrl=ipfsToHttp(uri);
    const meta=await fetch(metaUrl).then(r=>r.json()).catch(()=>({}));
    const img=ipfsToHttp(meta.image||meta.image_url||'');
    
    // Guardar metadata para el modal
    currentNFTMetadata = {
      id: id.toString(),
      uri: uri,
      name: meta.name || 'Halloween Spook #' + id,
      description: meta.description || 'A spooky NFT from the Halloween collection',
      image: img,
      attributes: meta.attributes || []
    };
    
    document.getElementById('ownedTokenId').textContent=id;
    document.getElementById('ownedTokenUri').textContent=uri;
    document.getElementById('ownedImg').src=img;
    document.getElementById('ownedSection').style.display='block';
  }catch(e){ 
    console.warn('No NFT found',e); 
    document.getElementById('ownedSection').style.display='none';
  }
}

function openModal(){
  const modal = document.getElementById('nftModal');
  const metadata = currentNFTMetadata;
  
  // Llenar datos del modal
  document.getElementById('modalNftImage').src = metadata.image;
  document.getElementById('modalName').textContent = metadata.name;
  document.getElementById('modalDescription').textContent = metadata.description;
  document.getElementById('modalTokenId').textContent = metadata.id;
  document.getElementById('modalTokenUri').textContent = metadata.uri;
  
  // Mostrar atributos si existen
  if(metadata.attributes && metadata.attributes.length > 0){
    const grid = document.getElementById('attributesGrid');
    grid.innerHTML = '';
    metadata.attributes.forEach(attr => {
      const card = document.createElement('div');
      card.className = 'attribute-card';
      card.innerHTML = `
        <div class="attribute-type">${attr.trait_type || 'Property'}</div>
        <div class="attribute-value">${attr.value}</div>
      `;
      grid.appendChild(card);
    });
    document.getElementById('attributesSection').style.display = 'block';
  } else {
    document.getElementById('attributesSection').style.display = 'none';
  }
  
  modal.classList.add('show');
  document.body.style.overflow = 'hidden';
}

function closeModal(){
  const modal = document.getElementById('nftModal');
  modal.classList.remove('show');
  document.body.style.overflow = 'auto';
}

function closeModalOnOverlay(event){
  if(event.target.id === 'nftModal'){
    closeModal();
  }
}

async function connectWallet(){
  try{
    provider=new ethers.providers.Web3Provider(window.ethereum);
    await provider.send("eth_requestAccounts",[]);
    signer=provider.getSigner(); userAddress=await signer.getAddress();
    nftContract=new ethers.Contract(CONFIG.NFT_CONTRACT,NFT_ABI,signer);
    isConnected = true;
    document.getElementById('walletAddress').style.display='block';
    document.getElementById('walletAddress').textContent=userAddress;
    updateConnectButton(true);
    document.getElementById('mintBtn').disabled=false;
    showStatus('Wallet connected!','success');
    const hasMinted=await nftContract.minted(userAddress);
    if(hasMinted){ document.getElementById('mintBtn').disabled=true; await showOwnedNFT();}
  }catch(e){
    showStatus('Error: '+e.message,'error');
    resetUI();
  }
}

async function mintNFT(){
  const BASE="ipfs://bafybeieumajnuu67lxlctlcqvb5cdqfzipaozatt44ah3sbdgnosbryori/";
  const rand=1+(crypto.getRandomValues(new Uint32Array(1))[0]%100);
  const uri=`${BASE}${rand}.json`;
  showStatus('Minting...','info');
  const iface=new ethers.utils.Interface(NFT_ABI);
  const callData=iface.encodeFunctionData('mint',[uri]);
  const dataHash=ethers.utils.keccak256(callData);
  const domain={name:'PermissionedMetaTxHub',version:'1',chainId:CONFIG.CHAIN_ID,verifyingContract:CONFIG.HUB_CONTRACT};
  const types={Forward:[{name:'from',type:'address'},{name:'to',type:'address'},{name:'value',type:'uint256'},{name:'space',type:'uint32'},{name:'nonce',type:'uint256'},{name:'deadline',type:'uint256'},{name:'dataHash',type:'bytes32'},{name:'caller',type:'address'}]};
  const msg={from:userAddress,to:CONFIG.NFT_CONTRACT,value:0,space:111,nonce:Date.now(),deadline:Math.floor(Date.now()/1000)+86400,dataHash,caller:'0xA7293f15A7c1cF346aafD603a8D0E1Bc681d7b45'};
  const sig=await signer._signTypedData(domain,types,msg);
  const resp=await fetch(CONFIG.RELAYER_ENDPOINT,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({forward:msg,signature:sig,callData})});
  const out=await resp.json();
  if(out.txHash){showStatus(`Minted! <a href="https://amoy.polygonscan.com/tx/${out.txHash}" target="_blank">View</a>`,'success');}
  else{showStatus('Mint failed','error');}
  setTimeout(showOwnedNFT,4000);
}
</script>
</body>
</html>