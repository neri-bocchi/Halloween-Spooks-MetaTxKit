<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Halloween Spooks NFT - Free Mint</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#0a0514;color:#e0e0e0;min-height:100vh;position:relative;overflow-x:hidden}
    .spooky-bg{position:fixed;inset:0;z-index:-1;background:
      radial-gradient(circle at 20% 50%,rgba(139,0,255,.15) 0%,transparent 50%),
      radial-gradient(circle at 80% 20%,rgba(255,69,0,.1) 0%,transparent 50%),
      radial-gradient(circle at 50% 80%,rgba(0,0,0,.8) 0%,transparent 50%)}
    .floating-ghost{position:fixed;font-size:60px;opacity:.1;animation:float 20s infinite ease-in-out;z-index:-1}
    @keyframes float{0%,100%{transform:translateY(0)translateX(0)}25%{transform:translateY(-30px)translateX(20px)}50%{transform:translateY(-60px)translateX(-20px)}75%{transform:translateY(-30px)translateX(20px)}}
    .container{max-width:600px;margin:0 auto;padding:40px 20px}
    header{text-align:center;margin: bottom 1px;padding-top:10px}
    .logo{font-size:60px;margin-bottom:20px;animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
    h1{font-size:48px;font-weight:900;background:linear-gradient(135deg,#ff6b00 0%,#8b00ff 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:15px;text-shadow:0 0 30px rgba(255,107,0,.3)}
    .subtitle{font-size:18px;color:#b0b0b0;margin-bottom:10px}
    .network-badge{display:inline-block;padding:8px 20px;background:rgba(139,0,255,.2);border:1px solid rgba(139,0,255,.4);border-radius:20px;font-size:13px;color:#8b00ff;font-weight:600}
    .mint-card{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.1);border-radius:24px;padding:40px;backdrop-filter:blur(10px);box-shadow:0 20px 60px rgba(0,0,0,.5)}
    .nft-preview{width:100%;aspect-ratio:1;background:linear-gradient(135deg,rgba(139,0,255,.1) 0%,rgba(255,69,0,.1) 100%);border-radius:20px;display:flex;align-items:center;justify-content:center;font-size:120px;margin-bottom:30px;border:2px solid rgba(139,0,255,.3);position:relative;overflow:hidden}
    .info-section{margin-bottom:30px}
    .info-row{display:flex;justify-content:space-between;padding:15px 0;border-bottom:1px solid rgba(255,255,255,.05)}
    .info-row:last-child{border-bottom:none}
    .info-label{color:#808080;font-size:14px}
    .info-value{color:#fff;font-weight:600;font-size:14px}
    .free-badge{background:linear-gradient(135deg,#ff6b00 0%,#ff4500 100%);padding:4px 12px;border-radius:12px;font-size:12px;font-weight:700;color:white}
    .wallet-address{background:rgba(0,0,0,.3);padding:15px;border-radius:12px;font-family:'Courier New',monospace;font-size:13px;color:#8b00ff;text-align:center;margin-top:15px;border:1px solid rgba(139,0,255,.2)}
    .btn{width:100%;padding:18px;border-radius:16px;font-size:18px;font-weight:700;border:none;cursor:pointer;transition:all .3s ease;display:flex;align-items:center;justify-content:center;gap:12px}
    .btn-primary{background:linear-gradient(135deg,#ff6b00 0%,#8b00ff 100%);color:white;box-shadow:0 10px 40px rgba(255,107,0,.3)}
    .btn-primary:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 15px 50px rgba(255,107,0,.5)}
    .btn-primary:disabled{opacity:.5;cursor:not-allowed}
    .status-message{margin-top:20px;padding:15px;border-radius:12px;font-size:14px;text-align:center;display:none}
    .status-success{background:rgba(0,255,0,.1);border:1px solid rgba(0,255,0,.3);color:#00ff00}
    .status-error{background:rgba(255,0,0,.1);border:1px solid rgba(255,0,0,.3);color:#ff6b6b}
    .status-info{background:rgba(139,0,255,.1);border:1px solid rgba(139,0,255,.3);color:#8b00ff}
    .owned-card{margin-top:22px;background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:16px}
    .owned-grid{display:grid;grid-template-columns:120px 1fr;gap:16px;align-items:center}
    .owned-img{width:100%;aspect-ratio:1;border-radius:12px;object-fit:cover;border:1px solid rgba(255,255,255,.12);cursor:pointer}
    .mono{font-family:'Courier New',monospace;word-break:break-all;color:#c9c9c9}

    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(3px);display:none;align-items:center;justify-content:center;z-index:50}
    .modal{width:min(92vw,720px);max-height:86vh;overflow:auto;background:rgba(22,14,33,.98);border:1px solid rgba(255,255,255,.08);border-radius:20px;box-shadow:0 30px 100px rgba(0,0,0,.6);animation:pop .2s ease-out}
    @keyframes pop{from{transform:scale(.96);opacity:.6}to{transform:scale(1);opacity:1}}
    .modal-header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid rgba(255,255,255,.08)}
    .modal-title{font-weight:800;font-size:18px}
    .modal-close{background:transparent;border:none;color:#cfcfcf;font-size:24px;cursor:pointer;line-height:1}
    .modal-body{padding:16px 20px}
    .details-grid{display:grid;grid-template-columns:220px 1fr;gap:20px}
    .details-img{width:100%;aspect-ratio:1;border-radius:14px;object-fit:cover;border:1px solid rgba(255,255,255,.12)}
    .kv{display:grid;grid-template-columns:160px 1fr;gap:10px;margin-bottom:6px}
    .kv .k{color:#9a9a9a;font-size:13px}
    .kv .v{font-family:'Courier New',monospace;font-size:13px;word-break:break-all}
    .attrs{margin-top:10px;border-top:1px dashed rgba(255,255,255,.08);padding-top:10px}
    .attr{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid rgba(255,255,255,.05)}
    .attr:last-child{border-bottom:none}
    .badge-link{display:inline-block;margin-top:6px;font-size:12px;padding:6px 10px;border-radius:10px;border:1px solid rgba(139,0,255,.4);color:#bfa7ff;text-decoration:none}
  </style>
</head>
<body>
  <div class="spooky-bg"></div>
  <div class="floating-ghost" style="top:10%; left:10%;">ðŸ‘»</div>
  <div class="floating-ghost" style="top:60%; right:15%; animation-delay:-5s;">ðŸŽƒ</div>

  <div class="container">
    <header>
      <div class="logo">ðŸ‘»</div>
      <h1>Halloween Spooks</h1>
      <p class="subtitle">Free NFT Mint with Gasless Transactions</p>
      <div class="network-badge">âš¡ Powered by Meta-Transactions</div>
    </header>

    <div class="mint-card">
      <div class="nft-preview" id="nftPreview">ðŸŽƒ</div>

      <div class="info-section">
        <div class="info-row"><span class="info-label">Price</span><span class="free-badge">FREE</span></div>
        <div class="info-row"><span class="info-label">Limit per wallet</span><span class="info-value">1 NFT</span></div>
        <div class="info-row"><span class="info-label">Gas fees</span><span class="info-value">Sponsored ðŸŽ‰</span></div>
      </div>

      <button class="btn btn-primary" id="connectBtn" onclick="connectWallet()">ðŸ¦Š Connect Wallet</button>
      <div class="wallet-address" id="walletAddress" style="display:none;"></div>

      <button class="btn btn-primary" id="mintBtn" onclick="mintNFT()" disabled>
        <span id="mintBtnText">Mint my Spook</span>
      </button>

      <div class="status-message" id="statusMessage"></div>

      <div id="ownedSection" class="owned-card" style="display:none;">
        <div class="owned-grid">
          <img id="ownedImg" class="owned-img" alt="Your NFT"/>
          <div>
            <div style="display:flex;align-items:center;gap:8px;justify-content:space-between;">
              <strong>You can mint 1 token per address</strong>
              <a id="viewDetailsLink" class="badge-link" href="#">Ver detalles</a>
            </div>
            <div><strong>Token ID:</strong> <span id="ownedTokenId">-</span></div>
            <div><strong>Token URI:</strong> <span id="ownedTokenUri" class="mono">-</span></div>
          </div>
        </div>
      </div>
    </div>

    <footer>Built with ðŸ’œ using MetaTxKit & ERC-2771</footer>
  </div>

  <!-- Modal -->
  <div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document">
      <div class="modal-header">
        <div class="modal-title">ðŸŽƒ Detalles del NFT</div>
        <button id="modalClose" class="modal-close" aria-label="Cerrar">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="details-grid">
          <img id="modalImg" class="details-img" alt="NFT"/>
          <div>
            <div class="kv"><div class="k">Token ID</div><div id="kvTokenId" class="v">-</div></div>
            <div class="kv"><div class="k">Token URI</div><div id="kvTokenUri" class="v">-</div></div>
            <div class="kv"><div class="k">Metadata URL</div><div id="kvMetaUrl" class="v">-</div></div>
            <div class="kv"><div class="k">Name</div><div id="kvName" class="v">-</div></div>
            <div class="kv"><div class="k">Description</div><div id="kvDesc" class="v">-</div></div>
            <div class="attrs" id="attrs"></div>
            <div style="margin-top:10px">
              <a id="openMetaLink" class="badge-link" target="_blank" rel="noopener">Abrir metadata</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
const CONFIG = {
  NFT_CONTRACT: '0x0F835E9947f15A799eB173FEFE39f572279fA7Ac',
  HUB_CONTRACT: '0xe8cB75877D6277bCD423f39177BbEB32eDbd899b',
  RELAYER_ENDPOINT: 'http://127.0.0.1:3000/relay',
  CHAIN_ID: 80002,
  HTTP_GATEWAY: 'https://ipfs.io/ipfs/'
};

const NFT_ABI = [
  "function mint(string calldata tokenUri) public",
  "function minted(address) public view returns (bool)",
  "function myToken() public view returns (uint256 id, string memory uri)",
  "function tokenURI(uint256 tokenId) public view returns (string)"
];

let provider, signer, nftContract, userAddress;
let lastMetadata = null; // cache para el modal

function showStatus(msg, type){
  const el=document.getElementById('statusMessage');
  el.innerHTML=msg; el.className='status-message status-'+type; el.style.display='block';
}

function ipfsToHttp(uri){
  uri=uri?.replace('images/','');
  if(!uri) return '';
  if(uri.startsWith('ipfs://')) return CONFIG.HTTP_GATEWAY+uri.replace('ipfs://','');
  return uri;
}

function renderAttributes(attrs){
  const wrap = document.getElementById('attrs');
  wrap.innerHTML = '';
  if(!Array.isArray(attrs) || attrs.length===0){ return; }
  const title = document.createElement('div');
  title.style.marginBottom = '6px';
  title.style.fontWeight = '800';
  title.textContent = 'Atributos';
  wrap.appendChild(title);
  attrs.forEach(a=>{
    const row=document.createElement('div');
    row.className='attr';
    const left=document.createElement('div'); left.textContent=a.trait_type||a.display_type||'trait';
    const right=document.createElement('div'); right.className='mono'; right.textContent=String(a.value);
    row.appendChild(left); row.appendChild(right);
    wrap.appendChild(row);
  });
}

function openModal(){
  const backdrop = document.getElementById('modalBackdrop');
  backdrop.style.display='flex';
  backdrop.setAttribute('aria-hidden','false');
}
function closeModal(){
  const backdrop = document.getElementById('modalBackdrop');
  backdrop.style.display='none';
  backdrop.setAttribute('aria-hidden','true');
}

function populateModal(meta, id, tokenUri, metaUrl, imgUrl){
  document.getElementById('modalImg').src = imgUrl || '';
  document.getElementById('kvTokenId').textContent = id ?? '-';
  document.getElementById('kvTokenUri').textContent = tokenUri || '-';
  document.getElementById('kvMetaUrl').textContent = metaUrl || '-';
  document.getElementById('kvName').textContent = meta?.name || '-';
  document.getElementById('kvDesc').textContent = meta?.description || '-';
  document.getElementById('openMetaLink').href = metaUrl || '#';
  renderAttributes(meta?.attributes);
}

async function showOwnedNFT(){
  try{
    const res=await nftContract.myToken();
    const id=res.id||res[0];
    const uri=res.uri||res[1];
    if(!id||id==0){ document.getElementById('ownedSection').style.display='none'; return; }
    const metaUrl=ipfsToHttp(uri);
    const meta=await fetch(metaUrl).then(r=>r.json()).catch(()=>({}));
    const img=ipfsToHttp(meta.image||meta.image_url||'');
    document.getElementById('ownedTokenId').textContent=id;
    document.getElementById('ownedTokenUri').textContent=uri;
    const imgEl = document.getElementById('ownedImg');
    imgEl.src=img;
    document.getElementById('ownedSection').style.display='block';

    // guardar para el modal
    lastMetadata = { meta, id, uri, metaUrl, img };

    // listeners para abrir modal
    const openers = [imgEl, document.getElementById('viewDetailsLink')];
    openers.forEach(el=>{
      el.onclick = (ev)=>{ ev.preventDefault(); populateModal(meta,id,uri,metaUrl,img); openModal(); };
    });
  }catch(e){ console.warn('No NFT found',e); document.getElementById('ownedSection').style.display='none';}
}

async function connectWallet(){
  try{
    provider=new ethers.providers.Web3Provider(window.ethereum);
    await provider.send("eth_requestAccounts",[]);
    signer=provider.getSigner(); userAddress=await signer.getAddress();
    nftContract=new ethers.Contract(CONFIG.NFT_CONTRACT,NFT_ABI,signer);
    document.getElementById('walletAddress').style.display='block';
    document.getElementById('walletAddress').textContent=userAddress;
    document.getElementById('connectBtn').disabled=true;
    document.getElementById('mintBtn').disabled=false;
    showStatus('Wallet connected!','success');
    const hasMinted=await nftContract.minted(userAddress);
    if(hasMinted){ document.getElementById('mintBtn').disabled=true; await showOwnedNFT();}
  }catch(e){showStatus('Error: '+e.message,'error');}
}

async function mintNFT(){
  const BASE="ipfs://bafybeieumajnuu67lxlctlcqvb5cdqfzipaozatt44ah3sbdgnosbryori/";
  const rand=1+(crypto.getRandomValues(new Uint32Array(1))[0]%100);
  const uri=`${BASE}${rand}.json`;
  showStatus('Minting...','info');
  const iface=new ethers.utils.Interface(NFT_ABI);
  const callData=iface.encodeFunctionData('mint',[uri]);
  const dataHash=ethers.utils.keccak256(callData);
  const domain={name:'PermissionedMetaTxHub',version:'1',chainId:CONFIG.CHAIN_ID,verifyingContract:CONFIG.HUB_CONTRACT};
  const types={Forward:[{name:'from',type:'address'},{name:'to',type:'address'},{name:'value',type:'uint256'},{name:'space',type:'uint32'},{name:'nonce',type:'uint256'},{name:'deadline',type:'uint256'},{name:'dataHash',type:'bytes32'},{name:'caller',type:'address'}]};
  const msg={from:userAddress,to:CONFIG.NFT_CONTRACT,value:0,space:111,nonce:Date.now(),deadline:Math.floor(Date.now()/1000)+86400,dataHash,caller:'0xA7293f15A7c1cF346aafD603a8D0E1Bc681d7b45'};
  const sig=await signer._signTypedData(domain,types,msg);
  const resp=await fetch(CONFIG.RELAYER_ENDPOINT,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({forward:msg,signature:sig,callData})});
  const out=await resp.json();
  if(out.txHash){showStatus(`Minted! <a href="https://amoy.polygonscan.com/tx/${out.txHash}" target="_blank">View</a>`, 'success');}
  else{showStatus('Mint failed','error');}
  setTimeout(showOwnedNFT,4000);
}

// manejo de cierre de modal
(function modalWiring(){
  const backdrop = document.getElementById('modalBackdrop');
  const closeBtn = document.getElementById('modalClose');
  closeBtn.addEventListener('click', closeModal);
  backdrop.addEventListener('click', (e)=>{ if(e.target===backdrop) closeModal(); });
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });
})();
</script>
</body>
</html>
